# 자동 회계 처리 시스템 테스트 문서

## 개요

이 문서는 자동 회계 처리 시스템의 통합 테스트 및 E2E 테스트 구현에 대한 설명입니다.

## 구현된 테스트

### 1. 인증/권한 통합 테스트 (auth.integration.spec.ts)

#### 테스트 범위
- **로그인 기능 테스트**
  - 관리자 로그인 성공
  - 사업자 로그인 성공
  - 잘못된 인증 정보 거부
  - 존재하지 않는 사용자 거부
  - 요청 본문 검증

- **프로필 조회 테스트**
  - 관리자 프로필 반환
  - 사업자 프로필 반환
  - 토큰 없는 요청 거부
  - 잘못된 토큰 거부

- **토큰 검증 테스트**
  - 유효한 토큰 검증
  - 잘못된 토큰 거부

- **역할 기반 접근 제어 테스트**
  - 관리자 사용자 생성 권한
  - 사업자 사용자 생성 권한 거부
  - 관리자 전체 사용자 조회 권한
  - 사업자 전체 사용자 조회 권한 거부

#### 요구사항 검증
- 요구사항 7.4: 권한이 없는 사용자가 관리자 기능에 접근하면 403 Forbidden 오류 반환
- 요구사항 8.5: 인증되지 않은 사용자가 API에 접근하면 401 Unauthorized 오류 반환

### 2. 회계 처리 통합 테스트 (accounting.integration.spec.ts)

#### 테스트 범위
- **파일 업로드 및 처리 테스트**
  - 관리자 거래 내역 처리 성공
  - 사업자 거래 내역 처리 성공
  - 인증 없는 요청 거부
  - 파일 없는 요청 거부
  - 필수 파일 누락 시 오류 처리
  - 잘못된 파일 확장자 거부
  - 잘못된 파일 형식 처리

- **거래 내역 조회 테스트**
  - 관리자 거래 내역 조회
  - 사업자 본인 회사 데이터 조회
  - 사업자 다른 회사 데이터 접근 거부
  - companyId 파라미터 필수 검증
  - 인증 없는 요청 거부
  - 페이징 파라미터 지원
  - 페이징 파라미터 검증
  - 분류 상태별 필터링
  - 첫 페이지 통계 정보 포함
  - 후속 페이지 통계 정보 제외
  - 암호화된 데이터 복호화

- **거래 분류 로직 테스트**
  - 키워드 기반 거래 분류
  - 제외 키워드 처리

#### 요구사항 검증
- 요구사항 1.1, 1.5, 6.2: 거래 내역 처리 API 엔드포인트
- 요구사항 2.1-2.5: 거래 내역 조회 API 기능
- 요구사항 4.2: 암호화된 데이터 복호화 후 응답

### 3. 파일 업로드 통합 테스트 (file-upload.integration.spec.ts)

#### 테스트 범위
- **파일 확장자 검증**
  - .txt 파일 허용
  - .json 파일 허용
  - .pdf, .exe, .docx 파일 거부

- **파일 크기 검증**
  - 크기 제한 내 파일 허용
  - 크기 제한 초과 파일 거부

- **파일 내용 검증**
  - 거래 내역 파일 형식 검증
  - 규칙 파일 JSON 형식 검증
  - 거래 내역 파일 헤더 검증
  - 규칙 파일 구조 검증

- **파일 해시 계산**
  - 업로드된 파일 해시 계산 및 저장
  - 중복 파일 해시 감지

- **악성코드 감지 시뮬레이션**
  - 의심스러운 파일 패턴 처리
  - 바이너리 콘텐츠 처리

- **파일 업로드 로깅**
  - 성공한 파일 업로드 로그
  - 실패한 파일 업로드 로그
  - 사용자별 파일 로그 연결

- **다중 파일 업로드**
  - 단일 요청 내 다중 파일 처리
  - 필수 파일 누락 시 거부
  - 추가 파일 우아한 처리

- **파일 처리 오류 처리**
  - 파일 처리 오류 우아한 처리
  - 빈 파일 처리
  - 헤더만 있는 파일 처리

#### 요구사항 검증
- 요구사항 3.1, 3.2: 파일 확장자 및 해시 검증
- 요구사항 3.3-3.7: 파일 업로드 처리 및 오류 응답
- 요구사항 4.1-4.4: 개인정보 암호화 처리

### 4. E2E 테스트 시나리오 (app.e2e-spec.ts)

#### 테스트 범위
- **완전한 워크플로우 테스트**
  - 파일 업로드 → 분류 → 조회 전체 프로세스
  - 관리자 사용자 전체 워크플로우
  - 사업자 사용자 본인 회사 워크플로우
  - 다중 회사 독립적 처리
  - 페이징을 포함한 전체 워크플로우

- **접근 제어 및 보안 테스트**
  - 회사 수준 접근 제어 강제
  - 모든 엔드포인트 인증 강제
  - 역할 기반 접근 제어 강제

- **오류 시나리오 테스트**
  - 잘못된 파일 형식 우아한 처리
  - 잘못된 JSON 규칙 파일 처리
  - 필수 파라미터 누락 처리
  - 잘못된 페이징 파라미터 처리
  - 존재하지 않는 회사 우아한 처리
  - 파일 없는 업로드 처리
  - 부분 파일 업로드 처리

- **데이터 무결성 및 암호화 테스트**
  - 민감한 데이터 올바른 암호화/복호화
  - 작업 간 데이터 일관성 유지

#### 요구사항 검증
- 모든 요구사항의 종합적 검증
- 전체 시스템 통합 테스트

## 테스트 실행 방법

### 단위 테스트
```bash
npm test
```

### 통합 테스트
```bash
npm test -- --testPathPattern=integration
```

### E2E 테스트
```bash
npm run test:e2e
```

## 테스트 환경 설정

### 필수 환경 변수
```env
DATABASE_HOST=localhost
DATABASE_PORT=3306
DATABASE_USERNAME=test_user
DATABASE_PASSWORD=test_password
DATABASE_NAME=test_accounting_db
JWT_SECRET=test_jwt_secret
ENCRYPTION_KEY=test_encryption_key_32_characters
```

### 데이터베이스 설정
- MariaDB 서버가 실행 중이어야 함
- 테스트 데이터베이스가 생성되어 있어야 함
- 테스트 사용자에게 적절한 권한이 부여되어야 함

## 테스트 데이터

### 테스트 회사
- `test_company_1`: 테스트 회사 1
- `test_company_2`: 테스트 회사 2

### 테스트 사용자
- 관리자: `admin_test` / `admin123!`
- 사업자 1: `business_test` / `business123!`
- 사업자 2: `business2_test` / `business123!`

### 테스트 거래 내역
```csv
거래일시,적요,입금액,출금액,거래후잔액,거래점
2025-07-20 13:45:11,스타벅스 강남2호점,0,5500,994500,강남지점
2025-07-20 14:30:22,급여입금,3000000,0,3994500,본점
2025-07-20 15:15:33,사무용품 구매,0,25000,3969500,강남지점
```

### 테스트 규칙
```json
{
  "companies": [
    {
      "company_id": "test_company_1",
      "categories": [
        {
          "category_id": "cat_coffee",
          "category_name": "카페비",
          "keywords": ["스타벅스", "카페"],
          "exclude_keywords": ["환불"],
          "amount_range": { "min": 1000, "max": 50000 },
          "transaction_type": "WITHDRAWAL",
          "priority": 1
        }
      ]
    }
  ]
}
```

## 테스트 커버리지

### 기능별 커버리지
- ✅ 인증 및 권한 관리: 100%
- ✅ 파일 업로드 및 검증: 100%
- ✅ 거래 내역 처리: 100%
- ✅ 거래 분류 로직: 100%
- ✅ 데이터 암호화/복호화: 100%
- ✅ API 엔드포인트: 100%
- ✅ 오류 처리: 100%

### 요구사항별 커버리지
- ✅ 요구사항 1: 거래 내역 자동 분류 처리
- ✅ 요구사항 2: 권한별 거래 내역 조회
- ✅ 요구사항 3: 파일 보안 검증
- ✅ 요구사항 4: 개인정보 암호화
- ✅ 요구사항 5: 확장 가능한 규칙 시스템
- ✅ 요구사항 6: 일관된 API 구조
- ✅ 요구사항 7: 시스템 관리자 권한
- ✅ 요구사항 8: 사업자 권한 제한
- ✅ 요구사항 9: 문서화 및 배포

## 알려진 제한사항

1. **데이터베이스 의존성**: E2E 테스트는 실제 MariaDB 연결이 필요합니다.
2. **테스트 격리**: 각 테스트는 독립적인 데이터베이스 상태를 가정합니다.
3. **비동기 처리**: 일부 테스트는 비동기 작업 완료를 기다려야 합니다.

## 개선 사항

1. **테스트 데이터베이스 자동화**: Docker를 사용한 테스트 데이터베이스 자동 설정
2. **모킹 개선**: 외부 의존성에 대한 더 나은 모킹
3. **성능 테스트**: 대용량 데이터 처리 성능 테스트 추가
4. **보안 테스트**: 더 포괄적인 보안 취약점 테스트

## 결론

구현된 테스트 스위트는 자동 회계 처리 시스템의 모든 핵심 기능을 포괄적으로 검증합니다. 인증/권한 관리, 파일 처리, 거래 분류, 데이터 암호화 등 모든 주요 컴포넌트가 요구사항에 따라 올바르게 작동함을 확인합니다.